name: Versioning and Release

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  versioning:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # L·∫•y to√†n b·ªô l·ªãch s·ª≠ ƒë·ªÉ ki·ªÉm tra commit message

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm install

      - name: Extract branch and PR number
        id: extract
        run: |
          # L·∫•y nh√°nh
          BRANCH=${{ github.head_ref || github.ref_name }}
          echo "Branch: $BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          # L·∫•y s·ªë PR (n·∫øu c√≥)
          PR_NUMBER=${{ github.event.number || 0 }}
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          # L·∫•y th·ªùi gian ƒë·ªãnh d·∫°ng YYYYMMDD-HHMMSS (+07)
          TIME_STRING=$(TZ="Asia/Ho_Chi_Minh" date +%Y%m%d-%H%M%S)
          echo "TIME_STRING=$TIME_STRING" >> $GITHUB_ENV

      - name: Determine new version
        id: version
        run: |
          # L·∫•y phi√™n b·∫£n hi·ªán t·∫°i t·ª´ package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          # Ph√¢n t√°ch phi√™n b·∫£n (lo·∫°i b·ªè h·∫≠u t·ªë pre-release)
          IFS='.' read -r MAJOR MINOR PATCH <<< "${CURRENT_VERSION%%-*}"
          
          # L·∫•y commit message cu·ªëi
          LAST_COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          echo "Last commit message: $LAST_COMMIT_MESSAGE"
          
          # X√°c ƒë·ªãnh lo·∫°i tƒÉng phi√™n b·∫£n
          if echo "$LAST_COMMIT_MESSAGE" | grep -q "BREAKING CHANGE"; then
            VERSION_TYPE="major"
            NEW_MAJOR=$((MAJOR + 1))
            NEW_MINOR=0
            NEW_PATCH=0
            NEW_VERSION="${NEW_MAJOR}.${NEW_MINOR}.${NEW_PATCH}"
          elif echo "$LAST_COMMIT_MESSAGE" | grep -q "^feat"; then
            VERSION_TYPE="minor"
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0
            NEW_VERSION="${MAJOR}.${NEW_MINOR}.${NEW_PATCH}"
          else
            VERSION_TYPE="patch"
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
          fi
          
          # T√πy ch·ªânh phi√™n b·∫£n theo nh√°nh
          if [ "${{ env.BRANCH }}" = "main" ]; then
            # Nh√°nh main: tƒÉng patch/minor/major
            echo "New version: $NEW_VERSION"
          elif [ "${{ env.BRANCH }}" = "dev" ]; then
            # Nh√°nh dev: th√™m h·∫≠u t·ªë -dev.[time_string]
            NEW_VERSION="${NEW_VERSION}-dev.${{ env.TIME_STRING }}"
            echo "New version: $NEW_VERSION"
          elif [ "${{ env.PR_NUMBER }}" -gt 0 ]; then
            # Pull request: th√™m h·∫≠u t·ªë -pr[pr_number].[time_string]
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-pr${{ env.PR_NUMBER }}.${{ env.TIME_STRING }}"
            echo "New version: $NEW_VERSION"
          else
            # Nh√°nh kh√°c: tƒÉng patch v√† th√™m -dev.[time_string]
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}-dev.${{ env.TIME_STRING }}"
            echo "New version: $NEW_VERSION"
          fi
          
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "VERSION_TYPE=$VERSION_TYPE" >> $GITHUB_ENV

      - name: Update package.json and commit
        if: contains(fromJSON('["main", "dev"]'), env.BRANCH)
        run: |
          # C·∫≠p nh·∫≠t package.json
          sed -i "s/\"version\": \".*\"/\"version\": \"${{ env.NEW_VERSION }}\"/" package.json
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add package.json
          git commit -m "release: v${{ env.NEW_VERSION }}"
          
          # Build TypeScript
          npm run build
          git add dist/
          git commit -m "build: v${{ env.NEW_VERSION }}" || echo "No changes to commit"

      - name: Save version for PR or other branches
        if: "!contains(fromJSON('[\"main\", \"dev\"]'), env.BRANCH)"
        run: |
          echo "${{ env.NEW_VERSION }}" > version.txt
          echo "Version for branch/PR: ${{ env.NEW_VERSION }} (not committed)"

      - name: Publish to npm for PR
        if: env.PR_NUMBER > 0
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # T·∫°o b·∫£n sao package.json v·ªõi phi√™n b·∫£n m·ªõi
          sed -i "s/\"version\": \".*\"/\"version\": \"${{ env.NEW_VERSION }}\"/" package.json
          cat package.json
          
          # Build TypeScript
          npm run build || { echo "Build failed"; exit 1; }
          # Publish v·ªõi tag pr
          npm publish --access public --tag pr || { echo "Failed to publish PR to npm"; exit 1; }
      - name: Post comment on PR
        if: env.PR_NUMBER > 0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Chu·∫©n b·ªã n·ªôi dung b√¨nh lu·∫≠n
          COMMENT="üéâ This PR is included in version '${NEW_VERSION}'! üéâ\n\nThe release is available on:\n- [npm package](https://www.npmjs.com/package/@anhtrieunhu/math-utils/v/${NEW_VERSION})\n- [GitHub release](https://github.com/anhtrieunhu/math-utils/releases/tag/v${NEW_VERSION}) (if created)\n\nYour semantic-release-bot üöÄ"
          
          # G·ª≠i b√¨nh lu·∫≠n t·ªõi PR
          curl -X POST \
               -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               -d "{\"body\": \"$COMMENT\"}" \
               "https://api.github.com/repos/anhntk54/math-utils/issues/${PR_NUMBER}/comments" || echo "Failed to post comment on PR"

      - name: Send Discord notification
        run: |
          # Chu·∫©n b·ªã n·ªôi dung th√¥ng b√°o
          MESSAGE="**New Version Generated** üéâ\n"
          MESSAGE+="**Repository**: ${{ github.repository }}\n"
          MESSAGE+="**Branch**: ${{ env.BRANCH }}\n"
          if [ "${{ env.PR_NUMBER }}" -gt 0 ]; then
            MESSAGE+="**Pull Request**: #${{ env.PR_NUMBER }}\n"
          fi
          MESSAGE+="**Version**: ${{ env.NEW_VERSION }}\n"
          MESSAGE+="**Version Type**: ${{ env.VERSION_TYPE }}\n"
          MESSAGE+="**Commit**: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\n"
          
          # G·ª≠i th√¥ng b√°o t·ªõi Discord
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$MESSAGE\"}" \
               "${{ secrets.DISCORD_WEBHOOK }}" || echo "Failed to send Discord notification"

      - name: Tag and push
        if: contains(fromJSON('["main", "dev"]'), env.BRANCH)
        run: |
          git tag -a "v${{ env.NEW_VERSION }}" -m "Release v${{ env.NEW_VERSION }}"
          git push origin "${{ env.BRANCH }}"
          git push origin "v${{ env.NEW_VERSION }}"

      - name: Publish to npm for main and dev
        if: contains(fromJSON('["main", "dev"]'), env.BRANCH)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public
